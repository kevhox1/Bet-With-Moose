/**
 * SportsGameOdds Pusher Streaming Client v2
 * =========================================
 * Reads stream config from file (generated by Python launcher).
 *
 * Usage:
 *   python3 start_stream.py
 *
 * Or directly (if config file exists):
 *   SGO_CONFIG_FILE=/tmp/sgo_stream_config.json node pusher_stream_v2.js
 */

const fs = require("fs");
const fetch = require("node-fetch");
const Pusher = require("pusher-js");

// Configuration
const API_KEY = "7546525eada0352b926e60dbc6c42cb0";
const API_BASE_URL = "https://api.sportsgameodds.com/v2";
const CONFIG_FILE = process.env.SGO_CONFIG_FILE || "/tmp/sgo_stream_config.json";

// State
let EVENTS = new Map();
let pusher = null;
let channel = null;
let updatesReceived = 0;
let connectionState = "disconnected";

/**
 * Format event title for display
 */
const getEventTitle = (event) => {
  const away = event.teams?.away?.names?.medium || event.teams?.away?.names?.short || "Away";
  const home = event.teams?.home?.names?.medium || event.teams?.home?.names?.short || "Home";
  return `${away} @ ${home}`;
};

/**
 * Fetch events via Python helper (works around Node DNS issues)
 */
const fetchEventsViaPython = async (eventIDs) => {
  const { execSync } = require("child_process");
  try {
    const result = execSync(`python3 -c "
import requests
import json
r = requests.get('${API_BASE_URL}/events',
    headers={'x-api-key': '${API_KEY}'},
    params={'eventIDs': '${eventIDs}'}, timeout=30)
print(json.dumps(r.json()))
"`, { encoding: "utf-8", timeout: 30000 });
    return JSON.parse(result);
  } catch (error) {
    throw new Error(`Python fetch failed: ${error.message}`);
  }
};

/**
 * Handle real-time odds update
 */
const handleOddsUpdate = async (changedEvents) => {
  updatesReceived++;
  const timestamp = new Date().toISOString().substr(11, 8);

  console.log(`\n${"=".repeat(60)}`);
  console.log(`[UPDATE #${updatesReceived}] ${changedEvents.length} event(s) changed @ ${timestamp}`);

  const eventIDs = changedEvents.map(e => e.eventID).join(",");
  if (!eventIDs) return;

  const startTime = Date.now();
  try {
    const data = await fetchEventsViaPython(eventIDs);
    const fetchTime = Date.now() - startTime;

    console.log(`   Fetched ${data.data.length} events in ${fetchTime}ms`);

    data.data.forEach((event) => {
      EVENTS.set(event.eventID, event);
      const oddsCount = Object.keys(event.odds || {}).length;
      console.log(`   - ${getEventTitle(event)} (${oddsCount} odds)`);
    });

  } catch (error) {
    console.error(`   Error fetching events: ${error.message}`);
  }
};

/**
 * Main connection function
 */
const connect = async () => {
  console.log("=".repeat(60));
  console.log("SportsGameOdds Pusher Streaming Client v2");
  console.log("=".repeat(60));

  // Load config from file
  if (!fs.existsSync(CONFIG_FILE)) {
    console.error(`[ERROR] Config file not found: ${CONFIG_FILE}`);
    console.error("Run: python3 start_stream.py");
    process.exit(1);
  }

  console.log(`\n[INIT] Loading config from ${CONFIG_FILE}`);
  const streamData = JSON.parse(fs.readFileSync(CONFIG_FILE, "utf-8"));

  const { data: initialEvents, pusherKey, pusherOptions, channel: channelName } = streamData;

  console.log(`[INIT] Pusher Key: ${pusherKey}`);
  console.log(`[INIT] Channel: ${channelName}`);
  console.log(`[INIT] Cluster: ${pusherOptions.cluster}`);
  console.log(`[INIT] Initial events: ${initialEvents.length}`);

  // Seed initial data
  initialEvents.forEach((event) => {
    EVENTS.set(event.eventID, event);
    console.log(`   - ${getEventTitle(event)}`);
  });

  // Connect to Pusher
  console.log("\n[CONNECT] Initializing Pusher connection...");

  Pusher.logToConsole = true;  // Enable debug logging

  pusher = new Pusher(pusherKey, pusherOptions);

  // Connection state handlers
  pusher.connection.bind("state_change", (states) => {
    connectionState = states.current;
    console.log(`[STATE] ${states.previous} -> ${states.current}`);
  });

  pusher.connection.bind("connected", () => {
    console.log("[CONNECTED] WebSocket connection established");
  });

  pusher.connection.bind("error", (error) => {
    console.error(`[ERROR] Connection error: ${JSON.stringify(error)}`);
  });

  // Subscribe to channel
  console.log(`[SUBSCRIBE] Subscribing to ${channelName}...`);

  channel = pusher.subscribe(channelName);

  channel.bind("pusher:subscription_succeeded", () => {
    console.log(`[SUBSCRIBED] Successfully subscribed to ${channelName}`);
    console.log("\n[STREAM] Waiting for odds updates... (Ctrl+C to stop)\n");
  });

  channel.bind("pusher:subscription_error", (error) => {
    console.error(`[ERROR] Subscription failed: ${JSON.stringify(error)}`);
  });

  // Handle data events
  channel.bind("data", handleOddsUpdate);

  // Heartbeat
  setInterval(() => {
    console.log(`[HEARTBEAT] State: ${connectionState}, Updates: ${updatesReceived}, Events: ${EVENTS.size}`);
  }, 30000);
};

/**
 * Graceful shutdown
 */
const disconnect = () => {
  console.log("\n[STOP] Shutting down...");

  if (channel) pusher.unsubscribe(channel.name);
  if (pusher) pusher.disconnect();

  console.log(`[STATS] Total updates received: ${updatesReceived}`);
  console.log(`[STATS] Events tracked: ${EVENTS.size}`);
  process.exit(0);
};

process.on("SIGINT", disconnect);
process.on("SIGTERM", disconnect);

// Start
connect();
